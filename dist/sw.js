"use strict";var _slicedToArray=function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,n){var t=[],r=!0,o=!1,u=void 0;try{for(var s,c=e[Symbol.iterator]();!(r=(s=c.next()).done)&&(t.push(s.value),!n||t.length!==n);r=!0);}catch(e){o=!0,u=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw u}}return t}(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},WB_STORE=null,BG_STORE=null,IDB=self.indexedDB,getWBRKeys=function(){return new Promise(function(e,n){var t=WB_STORE.transaction("requests","readwrite").objectStore("requests").getAllKeys();t.onerror=function(){return n},t.onsuccess=function(){e(t.result)}})},getWBR=function(r){return new Promise(function(e,n){var t=WB_STORE.transaction("requests","readwrite").objectStore("requests").get(r);t.onerror=function(){return n},t.onsuccess=function(){e(_extends({},t.result,{key:r}))}})},getWBRRequests=function(){return new Promise(function(t){getWBRKeys().then(function(e){var n=e.map(function(e){return getWBR(e)});t(Promise.all(n))})})},getBGRKeys=function(){return new Promise(function(e,n){var t=BG_STORE.transaction("requests","readwrite").objectStore("requests").getAllKeys();t.onerror=function(){return n},t.onsuccess=function(){e(t.result)}})},getBGR=function(r){return new Promise(function(e,n){var t=BG_STORE.transaction("requests","readwrite").objectStore("requests").get(r);t.onerror=function(){return n},t.onsuccess=function(){e(t.result)}})},addBGR=function(r){return new Promise(function(e,n){var t=BG_STORE.transaction("requests","readwrite").objectStore("requests").add(r);t.onerror=function(){return n},t.onsuccess=function(){e(t.result)}})},putBGR=function(r){return new Promise(function(e,n){var t=BG_STORE.transaction("requests","readwrite").objectStore("requests").put(r);t.onerror=function(){return n},t.onsuccess=function(){e(t.result)}})},Requests=function(){return new Promise(function(t){getBGRKeys().then(function(e){var n=e.map(function(e){return getBGR(e)});t(Promise.all(n))})})},workboxDBQueueKeys=function(){return new Promise(function(e,n){var t=IDB.open("workbox-background-sync");t.onsuccess=function(){(WB_STORE=t.result).objectStoreNames.length&&e(getWBRKeys()),n()}})},syncResults=function(e,n){Requests().then(function(r){e.forEach(function(n){var e=r.sort(function(e,n){return n.key-e.key}),t=e.findIndex(function(e){return e.storableRequest.url===n.request.url&&!e.result});console.log("updating",e[t].key),0<=t&&(e[t]=_extends({},e[t],{result:{error:n.error&&n.error.toString(),response:n.response&&{status:n.response.status,statusText:n.response.statusText}},v:e[t].v+1}),putBGR(e[t]))}),n()})},syncRequests=function(e){return e.forEach(function(o){Promise.all([getBGR(o),getWBR(o)]).then(function(e){var n=_slicedToArray(e,2),t=n[0],r=n[1];void 0===t?addBGR(_extends({},r,{v:0})).then(function(e){return console.log("inserted",e)}):putBGR(_extends({},r,{key:o,v:t.v+1})).then(function(e){return console.log("updated",e)})})})},sycnDB=function(n){return workboxDBQueueKeys().then(function(e){console.log("Syncing",n),n&&n.length?syncResults(n,function(){return syncRequests(e)}):syncRequests(e)})},p=new Promise(function(e,n){var t=IDB.open("bgqueue");t.onupgradeneeded=function(){t.result.createObjectStore("requests",{keyPath:"key"})},t.onerror=function(){return n},t.onsuccess=function(){(BG_STORE=t.result).transaction("requests","readwrite").objectStore("requests").getAll().onsuccess=function(){e()}}}),bgSyncPlugin=function(e){return new workbox.backgroundSync.Plugin(e,{maxRetentionTime:1440,callbacks:{requestWillEnqueue:function(e){setTimeout(sycnDB,1e3)},queueDidReplay:function(e){sycnDB(e)}}})};